# Railway Environment Configuration Guide

## Required Environment Variables

### Public Variables (Safe to include in railway.json)
These variables are already configured in `railway.json` but can be overridden in Railway dashboard:

```env
NODE_ENV=production
NEXT_TELEMETRY_DISABLED=1
DATABASE_SSL=true
DATABASE_CONNECTION_POOL_SIZE=10
DATABASE_CONNECTION_TIMEOUT=30000
DATABASE_IDLE_TIMEOUT=600000
HEALTH_CHECK_TIMEOUT=30000
READINESS_CHECK_TIMEOUT=30000
DEPLOYMENT_ENVIRONMENT=production
ZERO_DOWNTIME_ENABLED=true
ESLINT_NO_DEV_ERRORS=true
```

### Secret Variables (Set in Railway Dashboard)
These MUST be configured through Railway's environment variables interface:

#### Authentication (Clerk)
```env
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_...
CLERK_SECRET_KEY=sk_live_...
```

#### Monitoring (Sentry)
```env
SENTRY_DSN=https://...@...ingest.sentry.io/...
SENTRY_ORGANIZATION=your-org-name
SENTRY_PROJECT=cfi-handbook
SENTRY_AUTH_TOKEN=sntrys_... (for source map uploads)
```

#### Analytics (PostHog)
```env
NEXT_PUBLIC_POSTHOG_KEY=phc_...
NEXT_PUBLIC_POSTHOG_HOST=https://us.i.posthog.com
```

#### Database (Automatically provided by Railway PostgreSQL service)
```env
DATABASE_URL=postgresql://... (auto-generated by Railway)
```

## Railway Setup Steps

### 1. Create Railway Project
```bash
# Install Railway CLI
npm install -g @railway/cli

# Login to Railway
railway login

# Create new project
railway new
```

### 2. Add PostgreSQL Service
```bash
# Add PostgreSQL database
railway add postgresql

# The DATABASE_URL will be automatically available
```

### 3. Configure Environment Variables
In Railway dashboard, go to your service → Variables tab:

1. **Public Variables**: Already set via railway.json
2. **Secret Variables**: Add each secret variable manually:
   - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
   - CLERK_SECRET_KEY
   - SENTRY_DSN
   - SENTRY_ORGANIZATION
   - SENTRY_PROJECT
   - SENTRY_AUTH_TOKEN
   - NEXT_PUBLIC_POSTHOG_KEY
   - NEXT_PUBLIC_POSTHOG_HOST

### 4. Configure Custom Domain (Optional)
1. Go to Settings → Domains
2. Add your custom domain
3. Configure DNS records as instructed

### 5. Enable Zero-Downtime Deployments
The configuration is already set in railway.json:
- Health check endpoint: `/api/health`
- Health check timeout: 300 seconds
- Restart policy: On failure (max 3 retries)

## Environment Validation

After deployment, verify your environment setup:

1. **Health Check**: Visit `https://your-app.railway.app/api/health`
2. **Readiness Check**: Visit `https://your-app.railway.app/api/ready`

Both endpoints should return status 200 with detailed health information.

## Troubleshooting

### Common Issues

1. **Database Connection Failures**
   - Ensure DATABASE_URL is available (check Railway PostgreSQL service)
   - Verify DATABASE_SSL=true for production

2. **Build Failures**
   - Check ESLINT_NO_DEV_ERRORS=true is set
   - Verify all required environment variables are configured

3. **Health Check Failures**
   - Check logs for specific error messages
   - Verify database migrations completed successfully
   - Ensure all required services are running

### Debug Commands
```bash
# Check environment variables
railway vars

# View logs
railway logs

# Connect to database
railway connect postgresql
```

## Security Considerations

1. **Never commit secrets** to version control
2. **Use Railway's environment variables** for all sensitive data
3. **Enable SSL** for database connections in production
4. **Monitor** deployment logs for any credential leaks
5. **Rotate secrets** regularly through Railway dashboard

## Monitoring Setup

The application includes comprehensive monitoring:

1. **Health Checks**: Automatic health monitoring via `/api/health`
2. **Sentry Integration**: Error tracking and performance monitoring
3. **PostHog Analytics**: User behavior analytics
4. **Railway Logs**: Deployment and runtime logs
